---
title: "drew_notes"
author: "Drew Faturos"
date: "11/8/2017"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(randomForest)
library(ggthemes)
library(stringr)
library(plotly)
source("practice_data.R")

```
 playing with randomForest package 
 

Using RandomForest package want to determine which variables are the most important and make plot dislaying which variabels are good predictors of ELU, so need to select good predictor variables. 
After converting all varaibles to either factor or numeric, 

```{r using random forest for our anaylsis }

efficacy_sumrf <- efficacy_summary %>% 
  select(-ESP) %>% 
  mutate(huPPB = as.numeric(huPPB), 
         muPPB = as.numeric(muPPB), 
         dosage = as.factor(dosage), 
         dose_int = as.factor(dose_int), 
         level = as.factor(level), 
         drug = as.factor(drug))

  #rename("Caseum Binding" = Caseum_binding)

str(efficacy_sumrf)

efficacy.rf <- randomForest( ELU~ ., data = efficacy_sumrf,
              na.action = na.roughfix,
                        ntree= 5000, 
                        importance = TRUE)



```
 notes: use %incMSE and export to ggplot to make a prettier graph! also in your report specify what is being specified and what is not being speciefied ie mtry etc. 
 MSE is mean decrease in accuracy 
 
also maybe do doseage so you can check dosage 
 
 
 
 
```{r playing with Random forest graph}
print(efficacy.rf)

head(variable_definitions)

trash <- 

variable_definitions$Name <- str_replace(variable_definitions$Name, " ", "_" )

efficacy_sumrf <- efficacy_summary %>% 
  select(-ESP) %>% 
  mutate(huPPB = as.numeric(huPPB), 
         muPPB = as.numeric(muPPB), 
         dosage = as.factor(dosage), 
         dose_int = as.factor(dose_int), 
         level = as.factor(level), 
         drug = as.factor(drug)) 


?left_join
?str_replace
variable

importance(efficacy.rf, type = 1)



graph <-importance(efficacy.rf, type = 1) %>% 
  as.data.frame() %>% 
  rownames_to_column() %>% 
  rename(variable = rowname, 
         mse = `%IncMSE`) %>%  
  left_join(variable_definitions, 
            by = c("variable" = "Name"))

str(graph)
trash <- graph %>% 
  strwrap(Definition, width = 20)

variable_definitions$Definition <- str_wrap(variable_definitions$Definition, 
                                            width = 20,) 


?left_join

title <- paste0 (c("Predicing Variable Importance Using"))


test <- graph %>% 
  filter(mse > 0) %>% 
  ggplot()+
  geom_point(aes(x = mse, 
                 y = reorder(Label, mse), 
                 color = Vitro_or_Vivo, 
                 text = paste('Mean Standard Error: ', round(mse, digits = 2), '\n',
                              'Variable: ', Label, '\n',
                              'Definition: ', str_wrap(Definition, width = 40)
                              )))+
  theme_minimal()+
  #ggtitle(title)+
  labs(y = "Variable", 
       x = "Importance", 
       color = "In Vivo, In Vitro, or Drug" )

?round

ggplotly(test, tooltip = c("text"))


  theme(legend.title = element_text( title = "In Vivo, In Vitro, or Drug" ))
 
?plotly
?theme
  
  ?labs

?str_wrap

?as.data.frame()

```



vignette("randomForest")


```{r writting function}
best_variables <- function(dep_var = "ELU", drug = FALSE, df = efficacy_summary){
  
  
  title <- paste0 ("Predicing Variable Importance Using ", as.character(dep_var))
  
  if (drug == FALSE){
    df <- df %>% 
    select(-drug)
  } 
  
  
  if(dep_var == "ELU"){
  dataset <- df %>% 
    select(-ESP) %>% 
    mutate(huPPB = as.numeric(huPPB), 
         muPPB = as.numeric(muPPB), 
         dosage = as.factor(dosage), 
         dose_int = as.factor(dose_int), 
         level = as.factor(level), 
         drug = as.factor(drug))

efficacy.rf <- randomForest( ELU~ ., data =dataset,
              na.action = na.roughfix,
                        ntree= 500, 
                        importance = TRUE)
  }
  
  if (dep_var == "ESP"){
    dataset <- df %>% 
      select(-ELU) %>% 
    mutate(huPPB = as.numeric(huPPB), 
         muPPB = as.numeric(muPPB), 
         dosage = as.factor(dosage), 
         dose_int = as.factor(dose_int), 
         level = as.factor(level), 
         drug = as.factor(drug))

efficacy.rf <- randomForest( ESP ~ ., data =dataset,
              na.action = na.roughfix,
                        ntree= 500, 
                        importance = TRUE)
  }
  
graph <-importance(efficacy.rf, type = 1) %>% 
  as.data.frame() %>% 
  rownames_to_column() %>% 
  rename(variable = rowname, 
         mse = `%IncMSE`) %>% 
  left_join(variable_definitions, 
            by = c("variable" = "Name"))

test <- graph %>% 
  filter(mse > 0) %>% 
  ggplot()+
  geom_point(aes(x = mse, 
                 y = reorder(Label, mse), 
                 color = Vitro_or_Vivo, 
                 text = paste('Mean Standard Error: ', round(mse, digits = 2), '\n',
                              'Variable: ', Label, '\n',
                              'Definition: ', str_wrap(Definition, width = 40)
                              )))+
  theme_minimal()+
  ggtitle(title)+
  labs(y = "Variable", 
       x = "Importance", 
       color = "" )


ggplotly(test, tooltip = c("text"))



}

```
add drug exlude if include drug is false select it out 


```{r testing function}


best_variables("ELU", drug = TRUE)
best_variables("ESP")

```


```{r trying out mtry}



#nunmber of predictors (mtry = 20/3 = 6.3, try mtry with 3 and mtry with 12 )


efficacy.rf2 <- randomForest( ELU~ ., data = efficacy_sumrf,
              na.action = na.roughfix,
                        importance = TRUE)

efficacy.rf3 <- randomForest( ELU~ ., data = efficacy_sumrf,
              na.action = na.roughfix,
              mtry = 3,
                        ntree= 500, 
                        importance = TRUE)


print(efficacy.rf2)
print(efficacy.rf3)

#looking at data leave mtry as default because it has the best %var explained 

varImpPlot(efficacy.rf)
varImpPlot(efficacy.rf2)
varImpPlot(efficacy.rf3)

```







```{r tutorial from help file }

data(iris)
?set.seed
#running ranndomForest Code
iris.rf <- randomForest(Species ~ ., data=iris,
                        importance=TRUE, proximity=TRUE)
View(iris)
print(iris.rf)

#looking at variable importance 
round(importance(iris.rf), 2)

## Do MDS on 1 - proximity:
iris.mds <- cmdscale(1 - iris.rf$proximity, eig=TRUE)
op <- par(pty="s")
pairs(cbind(iris[,1:4], iris.mds$points), cex=0.6, gap=0,
      col=c("red", "green", "blue")[as.numeric(iris$Species)],
      main="Iris Data: Predictors and MDS of Proximity Based on RandomForest")
par(op)

print(iris.mds$GOF)

## Regresion

data("airquality")
set.seed(131)
ozone.rf <- randomForest(Ozone ~ ., data=airquality,
                         mtry=3,importance=TRUE,
                         na.action=na.omit)
print(ozone.rf)

#show importance of variables
#higher value mean more important

round(importance(ozone.rf), 2)


##playing with randomforst variable importance plot

data(mtcars)
mtcars.rf <- randomForest(mpg~ ., data = mtcars, 
                          ntreee = 1000, 
                          keep.forest =FALSE, 
                          importance = TRUE)
varImpPlot(mtcars.rf)

```














Notes about the data we are analyzing 

all drugs testing are oral drugs 
elu unevolved lung
have drug penetration within various levels 

go from outside to inside, measure the bacterial load and look at colony forming units 

have rifomycin class drugs 


```{r importing example from excel and making graphs}
cmax <- read_excel("data/DRUG_CLASS_I_Mean_Cmax_Trough_Efficacy_R_DATA_ANALYSIS.xlsx",
                   sheet = "Mean_PK_Efficacy_In vitro", skip = 1, n_max = 12)

trough <- read_excel("data/DRUG_CLASS_I_Mean_Cmax_Trough_Efficacy_R_DATA_ANALYSIS.xlsx",
                     sheet = "Mean_PK_Efficacy_In vitro", skip = 16, n_max = 12)
# grouping by ELU
cmax_group <- gather(cmax, key= outcome, value = value_outcome, ELU:ESP)

group_test <- gather(cmax_group, key = variable, value = value_variable, PLA:SLE)

group_test%>% 
  #filter(outcome =="ESP") %>% 
  mutate(value_variable = as.numeric(value_variable)) %>% 
  ggplot()+
  geom_histogram(aes( x = value_variable))+
  facet_wrap(~variable)

str(group_test)





```

