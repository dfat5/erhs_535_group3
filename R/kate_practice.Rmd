---
title: "univariate models"
author: "Kate Huebner"
date: "11/1/2017"
output: word_document
---

Modelling dependent~independent variables to determine variables associated with drug efficacy against TB. Dependent Variables are ELU (efficacy in the lungs) and ESP (efficacy in the spleen). SPleen and lung are the main outcome variables. Cmax and Trough indicate different drug concentrations and values are averaged across many mice at different drug doseages. Dependent variables include biologic and chemical (in vitro) measures. 

Extensions to 'ggplot2' respecting the grammar of graphics
paradigm. Provides new statistics to locate and tag peaks and valleys in 2D
plots, a statistics to add a label with the equation of a polynomial fitted
with lm(), or R^2 or adjusted R^2 or information criteria for any model
fitted with function lm(). Additional statistics give access to functions
in package 'broom'. Provides a function for flexibly converting time
series to data frames suitable for plotting with ggplot(). In addition
provides statistics and ggplot geometries useful for diagnosing what data
are passed to compute_group() and compute_panel() functions and to
geometries.

Kate assignment- Regression model with lm. fit linear regression that are univariate and do separate variables. try a backwards stepwise regression. one would be univariate model for each thing separately, maybe by dose separate as well. i will do univariate with lm and use ggmisc. i will focus on the lung. 

```{r global_Options, echo=TRUE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE,
                      warning = FALSE, error = FALSE)
```

```{r echo=FALSE}
#Loading libraires
library(dplyr)
library(tidyr)
library(readr)
library(ggplot2)
library(ggthemes)
library(readxl)
library(ggpmisc)
library(broom)
library(devtools)
library(ggfortify)

```

```{r}
#Reading in unclean data
source("practice_data.R")

```
```{r}
Cmax <- efficacy_summary %>% 
  filter(level == "Cmax") %>% 
  gather(key = independent_var, value = indep_measure, -drug, -dosage, -dose_int, -level, -ELU, -ESP, na.rm = TRUE) %>% 
  select(-ESP)
#add in rename of indep_variables here
head(Cmax)
```


```{r}
#histogram
histogram_plot <- Cmax %>% 
  ggplot(aes(x = indep_measure)) +
  geom_histogram() +
  labs(x = "Independent variable", y = "Dependent Variable") +
  facet_wrap(~independent_var, scales = "free")
  
histogram_plot
```

```{r fig.width=8, fig.height=6}
scatter_plot <- Cmax %>% 
  ggplot(aes(x = indep_measure, y = ELU, color = dose_int)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = lm, se = FALSE) +
  labs(x = "Independent variable", y = "Dependent Variable") +
  facet_wrap(~independent_var, scales = "free_x")
  
scatter_plot
```
```{r}
# ##Trying lm on one variable
# Caseum_binding <- Cmax %>% 
#   filter(independent_var == "Caseum_binding") %>% 
#   filter(dose_int == "BID") %>% 
#   select(ELU, indep_measure) 
#  
# Caseum_binding_mod <- lm(ELU ~ indep_measure, data = Caseum_binding)
# 
# class(Caseum_binding_mod)
# names(Caseum_binding_mod)
# glance(Caseum_binding_mod)
# tidy(Caseum_binding_mod)

```

```{r}
#Univariate Models
#scale by independent measure: subtracting the mean value from the independent variable and dividing by the overall standard. that way the final mean is 0 and the st dv is 1. gives all variables a similar mean. that way the slope is comparable across everything
model_function <- function(df) {
    model_results <- lm(ELU ~ scale(indep_measure), data = df)
}
```

```{r}
estimate_results <- Cmax %>% 
  group_by(independent_var, dose_int) %>% 
  nest() %>% 
  mutate(mod_results = purrr::map(data, model_function)) %>% 
  mutate(mod_coefs = purrr::map(mod_results, broom::tidy)) %>% 
  select(independent_var, dose_int, mod_results, mod_coefs) %>% 
  unnest(mod_coefs) %>% 
  filter(term == "scale(indep_measure)")
  
estimate_results
```
#use forcat:fct_reorder to graph scatterplot of coefficients on x and indep_var on y

```{r, fig.height = 4, fig.width = 7}
#we are reordering the indep var by the estimate value maximum. 
#bigger point size has less variance
coef_plot <- estimate_results %>%
  mutate(independent_var = forcats::fct_reorder(independent_var, estimate, fun = max)) %>%
  rename(Dose_Interval = dose_int) %>% 
  ggplot(aes(x = estimate, y = independent_var, color = Dose_Interval)) +
  geom_point(aes(size = 1 / std.error)) +
  scale_size_continuous(guide = FALSE) +
  theme_few() + 
  ggtitle(label = "Linear model coefficients as function of independent variables, \n by drug dose and model uncertainty", subtitle = "smaller points have more uncertainty than larger points") +
  geom_vline(xintercept = 0, color = "cornflower blue") 

coef_plot

```

#plot, the dependent variables (ELU  across individual mice). many mouse replicates for each drug

```{r}
library(ggbeeswarm)
str(clean_2_combined)
head(clean_2_combined)

ind_mouse_data <- clean_2_combined %>% 
  select(drug, mouse_id, lung_efficacy) %>% 
  mutate(drug = as.factor(drug)) %>% 
  mutate(mouse_id = as.factor(mouse_id)) %>% 
  group_by(drug) 
  
ind_mouse_plot <- ind_mouse_data %>%   
  ggplot(aes(x = drug, y = lung_efficacy, color = mouse_id)) +
  geom_beeswarm() +
  ylab("Colony Forming Units") +
  theme_few()
  
ind_mouse_plot

```

#Try making individual functions for each plot
